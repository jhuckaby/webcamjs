(function(u){var v;function l(){var e=Error.apply(this,arguments);e.name=this.name="FlashError";this.stack=e.stack;this.message=e.message}function g(){var e=Error.apply(this,arguments);e.name=this.name="WebcamError";this.stack=e.stack;this.message=e.message}var e=function(){};e.prototype=Error.prototype;l.prototype=new e;g.prototype=new e;var w={version:"1.0.26",protocol:location.protocol.match(/https/i)?"https":"http",inited:false,loaded:false,live:false,userMedia:true,iOS:/iPad|iPhone|iPod/.test(navigator.userAgent)&&!u.MSStream,params:{width:0,height:0,dest_width:0,dest_height:0,image_format:"jpeg",jpeg_quality:90,enable_flash:true,force_flash:false,flip_horiz:false,fps:30,upload_name:"webcam",constraints:null,swfURL:"",flashNotDetectedText:"ERROR: No Adobe Flash Player detected.  Webcam.js relies on Flash for browsers that do not support getUserMedia (like yours).",noInterfaceFoundText:"No supported webcam interface found.",unfreeze_snap:true,iosPlaceholderText:"Click here to open camera.",user_callback:null,user_canvas:null},errors:{FlashError:l,WebcamError:g},hooks:{},init:function(){var t=this;this.mediaDevices=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?navigator.mediaDevices:navigator.mozGetUserMedia||navigator.webkitGetUserMedia?{getUserMedia:function(a){return new Promise(function(e,t){(navigator.mozGetUserMedia||navigator.webkitGetUserMedia).call(navigator,a,e,t)})}}:null;u.URL=u.URL||u.webkitURL||u.mozURL||u.msURL;this.userMedia=this.userMedia&&!!this.mediaDevices&&!!u.URL;if(navigator.userAgent.match(/Firefox\D+(\d+)/)){if(parseInt(RegExp.$1,10)<21)this.userMedia=null}if(this.userMedia){u.addEventListener("beforeunload",function(e){t.reset()})}},exifOrientation:function(e){var t=new DataView(e);if(t.getUint8(0)!=255||t.getUint8(1)!=216){console.log("Not a valid JPEG file");return 0}var a=2;var i=null;while(a<e.byteLength){if(t.getUint8(a)!=255){console.log("Not a valid marker at offset "+a+", found: "+t.getUint8(a));return 0}i=t.getUint8(a+1);if(i==225){a+=4;var s="";for(n=0;n<4;n++){s+=String.fromCharCode(t.getUint8(a+n))}if(s!="Exif"){console.log("Not valid EXIF data found");return 0}a+=6;var r=null;if(t.getUint16(a)==18761){r=false}else if(t.getUint16(a)==19789){r=true}else{console.log("Not valid TIFF data! (no 0x4949 or 0x4D4D)");return 0}if(t.getUint16(a+2,!r)!=42){console.log("Not valid TIFF data! (no 0x002A)");return 0}var o=t.getUint32(a+4,!r);if(o<8){console.log("Not valid TIFF data! (First offset less than 8)",t.getUint32(a+4,!r));return 0}var h=a+o;var l=t.getUint16(h,!r);for(var c=0;c<l;c++){var d=h+c*12+2;if(t.getUint16(d,!r)==274){var f=t.getUint16(d+2,!r);var m=t.getUint32(d+4,!r);if(f!=3&&m!=1){console.log("Invalid EXIF orientation value type ("+f+") or count ("+m+")");return 0}var p=t.getUint16(d+8,!r);if(p<1||p>8){console.log("Invalid EXIF orientation value ("+p+")");return 0}return p}}}else{a+=2+t.getUint16(a+2)}}return 0},fixOrientation:function(e,i,s){var r=new Image;r.addEventListener("load",function(e){var t=document.createElement("canvas");var a=t.getContext("2d");if(i<5){t.width=r.width;t.height=r.height}else{t.width=r.height;t.height=r.width}switch(i){case 2:a.transform(-1,0,0,1,r.width,0);break;case 3:a.transform(-1,0,0,-1,r.width,r.height);break;case 4:a.transform(1,0,0,-1,0,r.height);break;case 5:a.transform(0,1,1,0,0,0);break;case 6:a.transform(0,1,-1,0,r.height,0);break;case 7:a.transform(0,-1,-1,0,r.height,r.width);break;case 8:a.transform(0,-1,1,0,0,r.width);break}a.drawImage(r,0,0);s.src=t.toDataURL()},false);r.src=e},attach:function(t,e){if(typeof t=="string"){t=document.getElementById(t)||document.querySelector(t)}if(!t){return this.dispatch("error",new g("Could not locate DOM element to attach to."))}this.container=t;t.innerHTML="";var a=document.createElement("div");t.appendChild(a);this.peg=a;if(!this.params.width)this.params.width=t.offsetWidth;if(!this.params.height)this.params.height=t.offsetHeight;if(!this.params.width||!this.params.height){return this.dispatch("error",new g("No width and/or height for webcam.  Please call set() first, or attach to a visible element."))}if(!this.params.dest_width)this.params.dest_width=this.params.width;if(!this.params.dest_height)this.params.dest_height=this.params.height;this.userMedia=v===undefined?this.userMedia:v;if(this.params.force_flash){v=this.userMedia;this.userMedia=null}if(typeof this.params.fps!=="number")this.params.fps=30;var i=this.params.width/this.params.dest_width;var s=this.params.height/this.params.dest_height;if(this.userMedia){var r=document.createElement("video");r.setAttribute("autoplay","autoplay");r.setAttribute("playsinline","playsinline");r.style.width=""+this.params.dest_width+"px";r.style.height=""+this.params.dest_height+"px";if(i!=1||s!=1){t.style.overflow="hidden";r.style.webkitTransformOrigin="0px 0px";r.style.mozTransformOrigin="0px 0px";r.style.msTransformOrigin="0px 0px";r.style.oTransformOrigin="0px 0px";r.style.transformOrigin="0px 0px";r.style.webkitTransform="scaleX("+i+") scaleY("+s+")";r.style.mozTransform="scaleX("+i+") scaleY("+s+")";r.style.msTransform="scaleX("+i+") scaleY("+s+")";r.style.oTransform="scaleX("+i+") scaleY("+s+")";r.style.transform="scaleX("+i+") scaleY("+s+")"}t.appendChild(r);this.video=r;this.inited=true;this.dispatch("init");if(!e){var n=this;this.mediaDevices.getUserMedia({audio:false,video:this.params.constraints||{mandatory:{minWidth:this.params.dest_width,minHeight:this.params.dest_height}}}).then(function(t){r.onloadedmetadata=function(e){n.stream=t;n.loaded=true;n.live=true;n.dispatch("load");n.dispatch("live");n.flip()};if("srcObject"in r){r.srcObject=t}else{r.src=u.URL.createObjectURL(t)}}).catch(function(e){if(n.params.enable_flash&&n.detectFlash()){setTimeout(function(){n.params.force_flash=1;n.attach(t)},1)}else{n.dispatch("error",e)}})}}else if(this.iOS){var l=document.createElement("div");l.id=this.container.id+"-ios_div";l.className="webcamjs-ios-placeholder";l.style.width=""+this.params.width+"px";l.style.height=""+this.params.height+"px";l.style.textAlign="center";l.style.display="table-cell";l.style.verticalAlign="middle";l.style.backgroundRepeat="no-repeat";l.style.backgroundSize="contain";l.style.backgroundPosition="center";var o=document.createElement("span");o.className="webcamjs-ios-text";o.innerHTML=this.params.iosPlaceholderText;l.appendChild(o);var c=document.createElement("img");c.id=this.container.id+"-ios_img";c.style.width=""+this.params.dest_width+"px";c.style.height=""+this.params.dest_height+"px";c.style.display="none";l.appendChild(c);var h=document.createElement("input");h.id=this.container.id+"-ios_input";h.setAttribute("type","file");h.setAttribute("accept","image/*");h.setAttribute("capture","camera");var n=this;var d=this.params;h.addEventListener("change",function(e){if(e.target.files.length>0&&e.target.files[0].type.indexOf("image/")==0){var a=URL.createObjectURL(e.target.files[0]);var h=new Image;h.addEventListener("load",function(e){var t=document.createElement("canvas");t.width=d.dest_width;t.height=d.dest_height;var a=t.getContext("2d");ratio=Math.min(h.width/d.dest_width,h.height/d.dest_height);var i=d.dest_width*ratio;var s=d.dest_height*ratio;var r=(h.width-i)/2;var n=(h.height-s)/2;a.drawImage(h,r,n,i,s,0,0,d.dest_width,d.dest_height);var o=t.toDataURL();c.src=o;l.style.backgroundImage="url('"+o+"')"},false);var t=new FileReader;t.addEventListener("load",function(e){var t=n.exifOrientation(e.target.result);if(t>1){n.fixOrientation(a,t,h)}else{h.src=a}},false);var i=new XMLHttpRequest;i.open("GET",a,true);i.responseType="blob";i.onload=function(e){if(this.status==200||this.status===0){t.readAsArrayBuffer(this.response)}};i.send()}},false);h.style.display="none";t.appendChild(h);l.addEventListener("click",function(e){if(d.user_callback){n.snap(d.user_callback,d.user_canvas)}else{h.style.display="block";h.focus();h.click();h.style.display="none"}},false);t.appendChild(l);this.loaded=true;this.live=true}else if(this.params.enable_flash&&this.detectFlash()){u.Webcam=w;var l=document.createElement("div");l.innerHTML=this.getSWFHTML();t.appendChild(l);var f=this;if(!e){this.on("init",function(){f.getMovie()._initCamera()})}}else{this.dispatch("error",new g(this.params.noInterfaceFoundText))}if(this.params.crop_width&&this.params.crop_height){var m=Math.floor(this.params.crop_width*i);var p=Math.floor(this.params.crop_height*s);t.style.width=""+m+"px";t.style.height=""+p+"px";t.style.overflow="hidden";t.scrollLeft=Math.floor(this.params.width/2-m/2);t.scrollTop=Math.floor(this.params.height/2-p/2)}else{t.style.width=""+this.params.width+"px";t.style.height=""+this.params.height+"px"}},getCameras:function(i){if(this.userMedia){this.mediaDevices.enumerateDevices().then(function(e){var t=[];for(var a=0;a<e.length;a++){if(e[a].kind==="videoinput"){t.push({id:e[a].deviceId,groupId:e[a].groupId,label:e[a].label})}}i(t)})}else if(this.iOS){}else if(this.params.enable_flash&&this.detectFlash()){var e=this.getMovie()._getCameras();var t=[];for(var a=0;a<e.length;a++){t.push({id:e[a],groupId:"",label:e[a]})}i(t)}},setAndInitCamera:function(e){if(this.userMedia){var a=this;var i=this.video;this.mediaDevices.getUserMedia({audio:false,video:{deviceId:{exact:e}}}).then(function(t){i.onloadedmetadata=function(e){a.stream=t;a.loaded=true;a.live=true;a.dispatch("load");a.dispatch("live");a.flip()};if("srcObject"in i){i.srcObject=t}else{i.src=u.URL.createObjectURL(t)}}).catch(function(e){if(a.params.enable_flash&&a.detectFlash()){setTimeout(function(){a.params.force_flash=1;a.attach(elem)},1)}else{a.dispatch("error",e)}})}else if(this.iOS){}else if(this.params.enable_flash&&this.detectFlash()){var t=this.getMovie();t._setCamera(e);t._initCamera()}},initCamera:function(){if(this.userMedia){var a=this;var e=this.video;this.mediaDevices.getUserMedia({audio:false,video:this.params.constraints||{mandatory:{minWidth:this.params.dest_width,minHeight:this.params.dest_height}}}).then(function(t){e.onloadedmetadata=function(e){a.stream=t;a.loaded=true;a.live=true;a.dispatch("load");a.dispatch("live");a.flip()};if("srcObject"in e){e.srcObject=t}else{e.src=u.URL.createObjectURL(t)}}).catch(function(e){if(a.params.enable_flash&&a.detectFlash()){setTimeout(function(){a.params.force_flash=1;a.attach(elem)},1)}else{a.dispatch("error",e)}})}else if(this.iOS){}else if(this.params.enable_flash&&this.detectFlash()){var t=this.getMovie();t._initCamera()}},reset:function(){if(this.preview_active)this.unfreeze();this.unflip();if(this.userMedia){if(this.stream){if(this.stream.getVideoTracks){var e=this.stream.getVideoTracks();if(e&&e[0]&&e[0].stop)e[0].stop()}else if(this.stream.stop){this.stream.stop()}}delete this.stream;delete this.video}if(this.userMedia!==true&&this.loaded&&!this.iOS){var t=this.getMovie();if(t&&t._releaseCamera)t._releaseCamera()}if(this.container){this.container.innerHTML="";delete this.container}this.loaded=false;this.live=false},set:function(){if(arguments.length==1){for(var e in arguments[0]){this.params[e]=arguments[0][e]}}else{this.params[arguments[0]]=arguments[1]}},on:function(e,t){e=e.replace(/^on/i,"").toLowerCase();if(!this.hooks[e])this.hooks[e]=[];this.hooks[e].push(t)},off:function(e,t){e=e.replace(/^on/i,"").toLowerCase();if(this.hooks[e]){if(t){var a=this.hooks[e].indexOf(t);if(a>-1)this.hooks[e].splice(a,1)}else{this.hooks[e]=[]}}},dispatch:function(){var e=arguments[0].replace(/^on/i,"").toLowerCase();var t=Array.prototype.slice.call(arguments,1);if(this.hooks[e]&&this.hooks[e].length){for(var a=0,i=this.hooks[e].length;a<i;a++){var s=this.hooks[e][a];if(typeof s=="function"){s.apply(this,t)}else if(typeof s=="object"&&s.length==2){s[0][s[1]].apply(s[0],t)}else if(u[s]){u[s].apply(u,t)}}return true}else if(e=="error"){var r;if(t[0]instanceof l||t[0]instanceof g){r=t[0].message}else{r="Could not access webcam: "+t[0].name+": "+t[0].message+" "+t[0].toString()}alert("Webcam.js Error: "+r)}return false},setSWFLocation:function(e){this.set("swfURL",e)},detectFlash:function(){var e="Shockwave Flash",t="ShockwaveFlash.ShockwaveFlash",a="application/x-shockwave-flash",i=u,s=navigator,r=false;if(typeof s.plugins!=="undefined"&&typeof s.plugins[e]==="object"){var n=s.plugins[e].description;if(n&&(typeof s.mimeTypes!=="undefined"&&s.mimeTypes[a]&&s.mimeTypes[a].enabledPlugin)){r=true}}else if(typeof i.ActiveXObject!=="undefined"){try{var o=new ActiveXObject(t);if(o){var h=o.GetVariable("$version");if(h)r=true}}catch(e){}}return r},getSWFHTML:function(){var e="",t=this.params.swfURL;if(location.protocol.match(/file/)){this.dispatch("error",new l("Flash does not work from local disk.  Please run from a web server."));return'<h3 style="color:red">ERROR: the Webcam.js Flash fallback does not work from local disk.  Please run it from a web server.</h3>'}if(!this.detectFlash()){this.dispatch("error",new l("Adobe Flash Player not found.  Please install from get.adobe.com/flashplayer and try again."));return'<h3 style="color:red">'+this.params.flashNotDetectedText+"</h3>"}if(!t){var a="";var i=document.getElementsByTagName("script");for(var s=0,r=i.length;s<r;s++){var n=i[s].getAttribute("src");if(n&&n.match(/\/webcam(\.min)?\.js/)){a=n.replace(/\/webcam(\.min)?\.js.*$/,"");s=r}}if(a)t=a+"/webcam.swf";else t="webcam.swf"}if(u.localStorage&&!localStorage.getItem("visited")){this.params.new_user=1;localStorage.setItem("visited",1)}var o="";for(var h in this.params){if(o)o+="&";o+=h+"="+escape(this.params[h])}e+='<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" type="application/x-shockwave-flash" codebase="'+this.protocol+'://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,0,0" width="'+this.params.width+'" height="'+this.params.height+'" id="webcam_movie_obj" align="middle"><param name="wmode" value="opaque" /><param name="allowScriptAccess" value="always" /><param name="allowFullScreen" value="false" /><param name="movie" value="'+t+'" /><param name="loop" value="false" /><param name="menu" value="false" /><param name="quality" value="best" /><param name="bgcolor" value="#ffffff" /><param name="flashvars" value="'+o+'"/><embed id="webcam_movie_embed" src="'+t+'" wmode="opaque" loop="false" menu="false" quality="best" bgcolor="#ffffff" width="'+this.params.width+'" height="'+this.params.height+'" name="webcam_movie_embed" align="middle" allowScriptAccess="always" allowFullScreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="'+o+'"></embed></object>';return e},getMovie:function(){if(!this.inited)return this.dispatch("error",new l("Flash Movie is not loaded yet"));var e=document.getElementById("webcam_movie_obj");if(!e||!e._snap)e=document.getElementById("webcam_movie_embed");if(!e)this.dispatch("error",new l("Cannot locate Flash movie in DOM"));return e},freeze:function(){var e=this;var t=this.params;if(this.preview_active)this.unfreeze();var a=this.params.width/this.params.dest_width;var i=this.params.height/this.params.dest_height;this.unflip();var s=t.crop_width||t.dest_width;var r=t.crop_height||t.dest_height;var n=document.createElement("canvas");n.width=s;n.height=r;var o=n.getContext("2d");this.preview_canvas=n;this.preview_context=o;if(a!=1||i!=1){n.style.webkitTransformOrigin="0px 0px";n.style.mozTransformOrigin="0px 0px";n.style.msTransformOrigin="0px 0px";n.style.oTransformOrigin="0px 0px";n.style.transformOrigin="0px 0px";n.style.webkitTransform="scaleX("+a+") scaleY("+i+")";n.style.mozTransform="scaleX("+a+") scaleY("+i+")";n.style.msTransform="scaleX("+a+") scaleY("+i+")";n.style.oTransform="scaleX("+a+") scaleY("+i+")";n.style.transform="scaleX("+a+") scaleY("+i+")"}this.snap(function(){n.style.position="relative";n.style.left=""+e.container.scrollLeft+"px";n.style.top=""+e.container.scrollTop+"px";e.container.insertBefore(n,e.peg);e.container.style.overflow="hidden";e.preview_active=true},n)},unfreeze:function(){if(this.preview_active){this.container.removeChild(this.preview_canvas);delete this.preview_context;delete this.preview_canvas;this.preview_active=false;this.flip()}},flip:function(){if(this.params.flip_horiz){var e=this.container.style;e.webkitTransform="scaleX(-1)";e.mozTransform="scaleX(-1)";e.msTransform="scaleX(-1)";e.oTransform="scaleX(-1)";e.transform="scaleX(-1)";e.filter="FlipH";e.msFilter="FlipH"}},unflip:function(){if(this.params.flip_horiz){var e=this.container.style;e.webkitTransform="scaleX(1)";e.mozTransform="scaleX(1)";e.msTransform="scaleX(1)";e.oTransform="scaleX(1)";e.transform="scaleX(1)";e.filter="";e.msFilter=""}},savePreview:function(e,t){var a=this.params;var i=this.preview_canvas;var s=this.preview_context;if(t){var r=t.getContext("2d");r.drawImage(i,0,0)}e(t?null:i.toDataURL("image/"+a.image_format,a.jpeg_quality/100),i,s);if(this.params.unfreeze_snap)this.unfreeze()},snap:function(i,s){if(!i)i=this.params.user_callback;if(!s)s=this.params.user_canvas;var e=this;var r=this.params;if(!this.loaded)return this.dispatch("error",new g("Webcam is not loaded yet"));if(!i)return this.dispatch("error",new g("Please provide a callback function or canvas to snap()"));if(this.preview_active){this.savePreview(i,s);return null}var n=document.createElement("canvas");n.width=this.params.dest_width;n.height=this.params.dest_height;var o=n.getContext("2d");if(this.params.flip_horiz){o.translate(r.dest_width,0);o.scale(-1,1)}var t=function(){if(this.src&&this.width&&this.height){o.drawImage(this,0,0,r.dest_width,r.dest_height)}if(r.crop_width&&r.crop_height){var e=document.createElement("canvas");e.width=r.crop_width;e.height=r.crop_height;var t=e.getContext("2d");t.drawImage(n,Math.floor(r.dest_width/2-r.crop_width/2),Math.floor(r.dest_height/2-r.crop_height/2),r.crop_width,r.crop_height,0,0,r.crop_width,r.crop_height);o=t;n=e}if(s){var a=s.getContext("2d");a.drawImage(n,0,0)}i(s?null:n.toDataURL("image/"+r.image_format,r.jpeg_quality/100),n,o)};if(this.userMedia){o.drawImage(this.video,0,0,this.params.dest_width,this.params.dest_height);t()}else if(this.iOS){var a=document.getElementById(this.container.id+"-ios_div");var h=document.getElementById(this.container.id+"-ios_img");var l=document.getElementById(this.container.id+"-ios_input");iFunc=function(e){t.call(h);h.removeEventListener("load",iFunc);a.style.backgroundImage="none";h.removeAttribute("src");l.value=null};if(!l.value){h.addEventListener("load",iFunc);l.style.display="block";l.focus();l.click();l.style.display="none"}else{iFunc(null)}}else{var c=this.getMovie()._snap();var h=new Image;h.onload=t;h.src="data:image/"+this.params.image_format+";base64,"+c}return null},configure:function(e){if(!e)e="camera";this.getMovie()._configure(e)},flashNotify:function(e,t){switch(e){case"flashInitComplete":this.inited=true;this.dispatch("init");break;case"flashLoadComplete":this.loaded=true;this.dispatch("load");break;case"cameraLive":this.live=true;this.dispatch("live");break;case"error":this.dispatch("error",new l(t));break;default:break}},b64ToUint6:function(e){return e>64&&e<91?e-65:e>96&&e<123?e-71:e>47&&e<58?e+4:e===43?62:e===47?63:0},base64DecToArr:function(e,t){var a=e.replace(/[^A-Za-z0-9\+\/]/g,""),i=a.length,s=t?Math.ceil((i*3+1>>2)/t)*t:i*3+1>>2,r=new Uint8Array(s);for(var n,o,h=0,l=0,c=0;c<i;c++){o=c&3;h|=this.b64ToUint6(a.charCodeAt(c))<<18-6*o;if(o===3||i-c===1){for(n=0;n<3&&l<s;n++,l++){r[l]=h>>>(16>>>n&24)&255}h=0}}return r},upload:function(e,t,a){var i=this.params.upload_name||"webcam";var s="";if(e.match(/^data\:image\/(\w+)/))s=RegExp.$1;else throw"Cannot locate image format in Data URI";var r=e.replace(/^data\:image\/\w+\;base64\,/,"");var n=new XMLHttpRequest;n.open("POST",t,true);if(n.upload&&n.upload.addEventListener){n.upload.addEventListener("progress",function(e){if(e.lengthComputable){var t=e.loaded/e.total;w.dispatch("uploadProgress",t,e)}},false)}var o=this;n.onload=function(){if(a)a.apply(o,[n.status,n.responseText,n.statusText]);w.dispatch("uploadComplete",n.status,n.responseText,n.statusText)};var h=new Blob([this.base64DecToArr(r)],{type:"image/"+s});var l=new FormData;l.append(i,h,i+"."+s.replace(/e/,""));n.send(l)}};w.init();if(typeof define==="function"&&define.amd){define(function(){return w})}else if(typeof module==="object"&&module.exports){module.exports=w}else{u.Webcam=w}})(window);